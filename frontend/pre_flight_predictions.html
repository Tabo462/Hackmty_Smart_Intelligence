<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Plate - Pre-Flight Predictions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      :root {
        --bs-primary: #070769;
        --bs-primary-rgb: 7,7,105;
      }
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .main-content {
        flex: 1;
      }
      #chatButton {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #chatWindow {
        position: fixed;
        bottom: 90px;
        right: 20px;
        z-index: 1055;
        width: 400px;
        max-width: 90vw;
      }
       footer {
         margin-top: auto;
       }
       /* Style for selected products list */
       #selectedProductsList {
         list-style-type: none;
         padding-left: 0;
       }
       #selectedProductsList li {
         background-color: #e9ecef;
         margin-bottom: 5px;
         padding: 5px 10px;
         border-radius: 4px;
         display: flex;
         justify-content: space-between;
         align-items: center;
       }
       #selectedProductsList button {
           padding: 0.1rem 0.4rem;
           font-size: 0.8rem;
       }
    </style>
</head>

<body>

    <nav class="navbar navbar-dark bg-primary sticky-top">
      <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuSidebar" aria-controls="menuSidebar">
          <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <img src="media_files/gategroup_logo.jpg" alt="Gategroup Logo" height="24" class="me-2">
          <span>Smart Plate</span>
        </a>
      </div>
    </nav>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="menuSidebar" aria-labelledby="menuSidebarLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="menuSidebarLabel">Menu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="nav flex-column nav-pills">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">
              Expiration
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="exp_adding.html">Exp - Adding</a></li>
              <li><a class="dropdown-item" href="exp_dashboard.html">Exp - Dashboard</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="pre_flight_predictions.html">Pre-Flight Predictions</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Other Link</a>
          </li>
        </ul>
      </div>
    </div>

    <div class="container-fluid mt-4 main-content">
      <div class="row mb-5">
        <div class="col-12 p-3">
          <h2>Input Flight Information</h2>
          <form id="prediction-form" novalidate>
            <div class="row g-3 mb-4 border-bottom pb-3">
               <div class="col-md-6">
                 <label for="flightId" class="form-label">Flight-ID</label>
                 <input type="text" class="form-control" id="flightId" required maxlength="7">
                 <div class="invalid-feedback">Please provide a Flight ID (max 7 characters).</div>
               </div>
               <div class="col-md-6">
                 <label for="origin" class="form-label">Origin</label>
                 <input type="text" class="form-control" id="origin" required maxlength="4">
                 <div class="invalid-feedback">Please provide an Origin code (max 4 characters).</div>
               </div>
               <div class="col-md-6">
                 <label for="flightType" class="form-label">Flight Type</label>
                 <input type="text" class="form-control" id="flightType" required placeholder="e.g., short-haul">
                 <div class="invalid-feedback">Must be 'short-haul', 'medium-haul', or 'long-haul'.</div>
               </div>
               <div class="col-md-6">
                 <label for="serviceType" class="form-label">Service Type</label>
                 <input type="text" class="form-control" id="serviceType" required placeholder="Retail or Pick & Pack">
                 <div class="invalid-feedback">Must be 'Retail' or 'Pick & Pack'.</div>
               </div>
               <div class="col-md-6">
                 <label for="passengerCount" class="form-label">Passenger Count</label>
                 <input type="number" class="form-control" id="passengerCount" required min="2" max="999">
                 <div class="invalid-feedback">Must be a number between 2 and 999.</div>
               </div>
            </div>

            <h4 class="mt-4">Select Products for Analysis</h4>
            <div class="row g-3 align-items-end mb-3">
                <div class="col-md-8">
                    <label for="productSelect" class="form-label">Available Products</label>
                    <select class="form-select" id="productSelect">
                        <option selected disabled value="">Choose a product...</option>
                        </select>
                </div>
                <div class="col-md-4">
                    <button type="button" class="btn btn-secondary w-100" id="addProductBtn">Add Product</button>
                </div>
            </div>

            <h5>Selected Products:</h5>
            <ul id="selectedProductsList">
                <li id="noProductsMsg" class="text-muted">No products added yet.</li>
            </ul>
             <div class="invalid-feedback d-block" id="productSelectionError" style="display: none;"> Please add at least one product.
            </div>


            <div class="col-12 mt-4">
                 <button type="submit" class="btn btn-primary">Get Prediction</button>
            </div>
          </form>
        </div>
      </div>
      <hr>
      <div class="row mt-5">
        <div class="col-12 p-3">
          <h3>Prediction for Flight <span id="predictedFlightId">[Flight ID]</span></h3>
          <div id="predictionResultArea">
            <p class="text-muted">Enter flight details and add products above to get predictions.</p>
          </div>
        </div>
      </div>
    </div>

    <button class="btn btn-primary btn-lg rounded-circle shadow" type="button" id="chatButton" data-bs-toggle="collapse" data-bs-target="#chatWindow" aria-expanded="false" aria-controls="chatWindow">
      <img src="media_files/gemini_logo.png" alt="Gemini Logo" width="30" height="30" style="filter: brightness(0) invert(1);">
    </button>
    <div class="collapse" id="chatWindow">
       <div class="card shadow-lg">
         <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
           <span>Chat Assistant</span>
           <button type="button" class="btn-close btn-close-white" data-bs-toggle="collapse" data-bs-target="#chatWindow" aria-label="Close"></button>
         </div>
         <div class="card-body" style="height: 400px; overflow-y: scroll;">
           <p><b>Assistant:</b> Hello! How can I help you?</p>
         </div>
         <div class="card-footer d-flex">
           <input type="text" class="form-control" placeholder="Type your message...">
           <button class="btn btn-primary ms-2">Send</button>
         </div>
       </div>
    </div>

    <footer class="bg-dark text-white p-5">
      <div class="container">
        <div class="row">
          <div class="col-md-3 mb-4">
            <h5 class="mb-3">Smart Plate</h5>
            <p class="text-white-50">Copyright &copy; 2025 Gategroup. <br>All rights reserved.</p>
          </div>
          <div class="col-md-3 mb-4">
            <h5>Explore</h5>
            <ul class="nav flex-column">
              <li class="nav-item mb-2"><a href="index.html" class="nav-link p-0 text-white-50">Home</a></li>
              <li class="nav-item mb-2"><a href="exp_dashboard.html" class="nav-link p-0 text-white-50">Dashboard</a></li>
              <li class="nav-item mb-2"><a href="pre_flight_predictions.html" class="nav-link p-0 text-white-50">Predictions</a></li>
              <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-white-50">About Us</a></li>
            </ul>
          </div>
          <div class="col-md-3 mb-4">
            <h5>Global Headquarters</h5>
            <address class="text-white-50" style="font-style: normal;">
              Gategroup<br>
              Street Address 123<br>
              Zurich, Switzerland
            </address>
          </div>
          <div class="col-md-3 mb-4">
            <h5>Legal</h5>
            <ul class="nav flex-column">
              <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-white-50">Terms & Conditions</a></li>
              <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-white-50">Data Privacy</a></li>
            </ul>
          </div>
        </div>
      </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // --- Available Products Data (Extracted from CSV) ---
      const availableProducts = {
        'Bread Roll Pack': 0.35,
        'Butter Cookies 75g': 0.75,
        'Sparkling Water 330ml': 0.45,
        'Still Water 500ml': 0.5,
        'Chocolate Bar 50g': 0.8,
        'Herbal Tea Bag': 0.06,
        'Juice 200ml': 0.55,
        'Snack Box Economy': 2.1,
        'Instant Coffee Stick': 0.08
        // Add more products here if needed
      };

      // --- DOM Elements ---
      const form = document.getElementById('prediction-form');
      const flightIdInput = document.getElementById('flightId');
      const originInput = document.getElementById('origin');
      const flightTypeInput = document.getElementById('flightType');
      const serviceTypeInput = document.getElementById('serviceType');
      const passengerCountInput = document.getElementById('passengerCount');
      const productSelect = document.getElementById('productSelect');
      const addProductBtn = document.getElementById('addProductBtn');
      const selectedProductsList = document.getElementById('selectedProductsList');
      const noProductsMsg = document.getElementById('noProductsMsg');
      const productSelectionError = document.getElementById('productSelectionError');
      const predictedFlightIdSpan = document.getElementById('predictedFlightId');
      const predictionResultArea = document.getElementById('predictionResultArea');

      // --- State for Selected Products ---
      let selectedProductsData = []; // Array to store { name: '...', cost: ... }

      // --- Populate Product Dropdown ---
      function populateProductDropdown() {
          Object.keys(availableProducts).sort().forEach(productName => {
              const option = document.createElement('option');
              option.value = productName;
              option.textContent = `${productName} ($${availableProducts[productName].toFixed(2)})`;
              productSelect.appendChild(option);
          });
      }

      // --- Update Display of Selected Products ---
      function updateSelectedProductsDisplay() {
          selectedProductsList.innerHTML = ''; // Clear current list
          if (selectedProductsData.length === 0) {
              selectedProductsList.appendChild(noProductsMsg); // Show 'No products' message
               productSelectionError.style.display = 'none'; // Hide error initially
          } else {
              noProductsMsg.remove(); // Hide 'No products' message
               productSelectionError.style.display = 'none'; // Hide error if products are added
              selectedProductsData.forEach((product, index) => {
                  const li = document.createElement('li');
                  li.textContent = `${product.name} ($${product.cost.toFixed(2)})`;

                  const removeBtn = document.createElement('button');
                  removeBtn.textContent = 'Remove';
                  removeBtn.type = 'button';
                  removeBtn.classList.add('btn', 'btn-sm', 'btn-outline-danger');
                  removeBtn.onclick = () => removeProduct(index); // Add remove functionality

                  li.appendChild(removeBtn);
                  selectedProductsList.appendChild(li);
              });
          }
      }

      // --- Add Product Functionality ---
      addProductBtn.addEventListener('click', () => {
          const selectedName = productSelect.value;
          if (selectedName && availableProducts[selectedName] !== undefined) {
              // Check if product is already added
              const isAlreadyAdded = selectedProductsData.some(p => p.name === selectedName);
              if (!isAlreadyAdded) {
                  selectedProductsData.push({
                      name: selectedName,
                      cost: availableProducts[selectedName]
                  });
                  updateSelectedProductsDisplay();
                  productSelect.selectedIndex = 0; // Reset dropdown
              } else {
                  alert(`${selectedName} is already added.`); // Optional: User feedback
              }
          }
      });

      // --- Remove Product Functionality ---
      function removeProduct(indexToRemove) {
          selectedProductsData.splice(indexToRemove, 1); // Remove item from array by index
          updateSelectedProductsDisplay();
      }


      // --- Form Validation & Submission ---
      function resetValidation() {
          form.querySelectorAll('.form-control, .form-select').forEach(input => {
              input.classList.remove('is-invalid');
          });
           productSelectionError.style.display = 'none'; // Hide product error
      }

      form.addEventListener('submit', function(event) {
          event.preventDefault();
          resetValidation();

          let isValid = true;
          let correctServiceType = '';
          let correctFlightType = '';

          // Validate basic flight info
          const flightIdValue = flightIdInput.value.trim();
          if (!flightIdValue || flightIdValue.length > 7) {
              flightIdInput.classList.add('is-invalid'); isValid = false;
          }
          const originValue = originInput.value.trim();
          if (!originValue || originValue.length > 4) {
              originInput.classList.add('is-invalid'); isValid = false;
          }
          const flightTypeValueLower = flightTypeInput.value.trim().toLowerCase();
          const validFlightTypes = ['short-haul', 'medium-haul', 'long-haul'];
          if (!flightTypeValueLower || !validFlightTypes.includes(flightTypeValueLower)) {
              flightTypeInput.classList.add('is-invalid'); isValid = false;
          } else {
              correctFlightType = flightTypeValueLower;
          }
          const serviceTypeValueLower = serviceTypeInput.value.trim().toLowerCase();
          if (serviceTypeValueLower === 'retail') {
              correctServiceType = 'Retail';
          } else if (serviceTypeValueLower === 'pick & pack') {
              correctServiceType = 'Pick & Pack';
          } else {
              serviceTypeInput.classList.add('is-invalid'); isValid = false;
          }
          const passengerCountValue = parseInt(passengerCountInput.value, 10);
          if (isNaN(passengerCountValue) || passengerCountValue < 2 || passengerCountValue > 999) {
              passengerCountInput.classList.add('is-invalid'); isValid = false;
          }

          // Validate product selection
          if (selectedProductsData.length === 0) {
               productSelectionError.style.display = 'block'; // Show product error
              isValid = false;
          }

          // --- Submission ---
          if (isValid) {
              predictedFlightIdSpan.textContent = flightIdValue;
              predictionResultArea.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> <p>Getting prediction for flight ' + flightIdValue + '</p>';

              // Extract product names and costs into separate lists
              const productNames = selectedProductsData.map(p => p.name);
              const unitCosts = selectedProductsData.map(p => p.cost);

              const dataToSend = {
                 flight_id: flightIdValue,
                 origin: originValue,
                 flight_type: correctFlightType,
                 service_type: correctServiceType,
                 passenger_count: passengerCountValue,
                 product_name: productNames, // Add the list of names
                 unit_cost: unitCosts       // Add the list of costs
              };

              console.log("Data to send:", dataToSend);

              // --- TODO: Add your backend API call logic here ---
              /*
              fetch('/api/predict', {
                 method: 'POST',
                 headers: { 'Content-Type': 'application/json' },
                 body: JSON.stringify(dataToSend)
              })
              .then(response => response.json())
              .then(data => {
                  // Assuming backend returns something like { prediction_results: [...] }
                  // You'll need to format and display these results appropriately
                  console.log("Received data:", data);
                  predictionResultArea.innerHTML = `<p>Prediction results received. (See console for details)</p>`; // Update this line
              })
              .catch(error => {
                  predictionResultArea.innerHTML = '<p class="text-danger">Error getting prediction.</p>';
                  console.error('Prediction API Error:', error);
              });
              */
          } else {
              predictedFlightIdSpan.textContent = "[Flight ID]";
              predictionResultArea.innerHTML = '<p class="text-danger">Please correct the errors in the form.</p>';
          }
      });

       // --- Initialize ---
      populateProductDropdown(); // Fill the dropdown on page load
      updateSelectedProductsDisplay(); // Show the initial "No products" message

      // Handle bfcache reload
      window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
          window.location.reload();
        }
      });
    </script>

</body>
</html>