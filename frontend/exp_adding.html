<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Smart Plate - Exp Adding</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
      :root {
        --bs-primary: #070769;
        --bs-primary-rgb: 7,7,105;
      }
      /* CORRECTED: Removed padding-top, adjusted flexbox */
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      .main-content {
        flex: 1;
        padding-bottom: 2rem;
      }
      #chatButton {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1050;
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      #chatWindow {
        position: fixed;
        bottom: 90px;
        right: 20px;
        z-index: 1055;
        width: 400px;
        max-width: 90vw;
      }
       footer {
         margin-top: auto;
       }
       
       /* Header gradient */
       .header-gradient {
         background: linear-gradient(135deg, #070769 0%, #2d2d9e 50%, #070769 100%);
         position: relative;
         overflow: hidden;
       }
       
       .header-gradient::before {
         content: '';
         position: absolute;
         top: -50%;
         right: -10%;
         width: 50%;
         height: 200%;
         background: radial-gradient(ellipse, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
         pointer-events: none;
       }
       
       /* Card improvements */
       .card {
         box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
         border: 1px solid rgba(0, 0, 0, 0.125);
         border-radius: 15px;
         transition: all 0.3s ease-in-out;
         animation: fadeInUp 0.6s ease-out;
       }
       
       .card:hover {
         box-shadow: 0 1rem 2rem rgba(0, 0, 0, 0.2);
         transform: translateY(-5px);
       }
       
       @keyframes fadeInUp {
         from {
           opacity: 0;
           transform: translateY(30px);
         }
         to {
           opacity: 1;
           transform: translateY(0);
         }
       }
       
       @keyframes fadeIn {
         from {
           opacity: 0;
         }
         to {
           opacity: 1;
         }
       }
       
       @keyframes slideIn {
         from {
           opacity: 0;
           transform: translateX(-20px);
         }
         to {
           opacity: 1;
           transform: translateX(0);
         }
       }
       
       @keyframes pulse {
         0%, 100% {
           opacity: 1;
         }
         50% {
           opacity: 0.5;
         }
       }
       
       @keyframes success {
         0%, 100% {
           background-color: #28a745;
         }
         50% {
           background-color: #20c997;
         }
       }
       
       .fade-in {
         animation: fadeIn 0.5s ease-out;
       }
       
       .slide-in {
         animation: slideIn 0.5s ease-out;
       }
       
       /* Product Form styling */
       .product-form {
           margin-top: 30px;
           padding: 30px;
           background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
           border-radius: 15px;
           border: 2px solid #E1F1F6;
           box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
           transition: all 0.3s ease-in-out;
       }
       
       .product-form:hover {
         box-shadow: 0 6px 20px rgba(7, 7, 105, 0.15);
       }

       .product-form h2 {
           margin-bottom: 25px;
           color: #070769;
           font-weight: 700;
       }

       .form-row {
           display: flex;
           gap: 20px;
           margin-bottom: 20px;
       }

       .form-group {
           flex: 1;
       }

       .form-group label {
           display: block;
           margin-bottom: 10px;
           color: #070769;
           font-weight: 600;
       }

       .form-group input {
           width: 100%;
           padding: 12px 15px;
           border: 2px solid #E1F1F6;
           border-radius: 10px;
           font-size: 16px;
           transition: all 0.3s ease;
       }
       
       .form-group input:focus {
           outline: none;
           border-color: #070769;
           box-shadow: 0 0 0 0.2rem rgba(7, 7, 105, 0.1);
           animation: scaleIn 0.2s ease-out;
       }
       
       @keyframes scaleIn {
         from {
           transform: scale(0.98);
         }
         to {
           transform: scale(1);
         }
       }

       .form-group input[readonly] {
           background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
           cursor: not-allowed;
           animation: pulse 2s ease-in-out infinite;
       }

       .form-actions {
           display: flex;
           gap: 15px;
           margin-top: 25px;
       }

       .form-actions button {
           flex: 1;
           border-radius: 10px;
           transition: all 0.3s ease-in-out;
           font-weight: 600;
           padding: 12px 20px;
       }

       .link-btn {
           background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
           color: white;
           box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
       }

       .link-btn:hover {
           background: linear-gradient(135deg, #218838 0%, #1ea080 100%);
           transform: translateY(-2px);
           box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
       }

       .save-btn {
           background: linear-gradient(135deg, #070769 0%, #2d2d9e 100%);
           color: white;
           box-shadow: 0 2px 8px rgba(7, 7, 105, 0.3);
       }

       .save-btn:hover {
           background: linear-gradient(135deg, #0a0a8a 0%, #4343b5 100%);
           transform: translateY(-2px);
           box-shadow: 0 4px 12px rgba(7, 7, 105, 0.4);
       }

       /* Scanner container improvements */
       .scanner-container-wrapper {
         animation: fadeInUp 0.8s ease-out;
       }
       
       #scanner-container {
         border: 3px solid #070769 !important;
         box-shadow: 0 8px 30px rgba(7, 7, 105, 0.3) !important;
         transition: all 0.3s ease !important;
       }
       
       /* Center the video feed within the scanner container */
       #scanner-container video {
         width: 100%;
         height: 100%;
         object-fit: cover;
         object-position: center;
       }
       
       /* Ensure canvas elements are properly aligned */
       #scanner-container canvas {
         position: absolute;
         top: 50%;
         left: 50%;
         transform: translate(-50%, -50%);
       }
       
       /* Barcode scanning area overlay - matches the actual scan area (20% margins) */
       .scan-area-overlay {
         position: absolute;
         top: 20%;
         left: 20%;
         right: 20%;
         bottom: 20%;
         border: 3px solid #28a745;
         border-radius: 10px;
         pointer-events: none;
         z-index: 20;
         box-shadow: inset 0 0 0 2px rgba(40, 167, 69, 0.3);
         display: none; /* Hidden by default, shown when scanner starts */
       }
       
       .scan-area-overlay::before,
       .scan-area-overlay::after {
         content: '';
         position: absolute;
         width: 40px;
         height: 40px;
         border: 4px solid #28a745;
       }
       
       .scan-area-overlay::before {
         top: -4px;
         left: -4px;
         border-right: none;
         border-bottom: none;
         border-top-left-radius: 10px;
       }
       
       .scan-area-overlay::after {
         bottom: -4px;
         right: -4px;
         border-left: none;
         border-top: none;
         border-bottom-right-radius: 10px;
       }
       
       #scanner-container:hover {
         border-color: #2d2d9e !important;
         box-shadow: 0 12px 40px rgba(7, 7, 105, 0.4) !important;
       }
       
       /* Button improvements */
       .btn {
         border-radius: 10px;
         transition: all 0.3s ease-in-out;
         font-weight: 500;
       }
       
       .btn:hover {
         transform: translateY(-2px);
         box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
       }
       
       .btn-primary, .btn-danger, .btn-warning, .btn-info {
         box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
       }
       
       /* Alert improvements */
       .alert {
         border-radius: 10px;
         animation: slideIn 0.4s ease-out;
       }
       
       /* Status success animation */
       .alert-primary {
         animation: pulse 2s ease-in-out infinite;
       }
       
       /* Modal improvements */
       #cameraModal > div {
         border-radius: 20px;
         box-shadow: 0 20px 60px rgba(7, 7, 105, 0.5) !important;
         animation: fadeInUp 0.4s ease-out;
       }
       
       /* Navbar brand hover animation */
       .navbar-brand {
         transition: all 0.3s ease-in-out;
       }
       
       .navbar-brand:hover {
         transform: scale(1.05);
       }
       
       .navbar-brand:hover span {
         text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
       }
       
       /* Menu toggle button hover animation */
       .navbar-toggler {
         transition: all 0.3s ease-in-out;
       }
       
       .navbar-toggler:hover {
         transform: scale(1.05);
         box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
       }
       
       @media (max-width: 768px) {
           /* Header optimization */
           .header-gradient h1 {
               font-size: 1.5rem !important;
           }
           
           .header-gradient p {
               font-size: 0.9rem;
           }
           
           /* Navbar brand optimization */
           .navbar-brand span {
               font-size: 1rem !important;
           }
           
           /* Scanner title */
           .scanner-container-wrapper h2 {
               font-size: 1.3rem;
           }
           
           /* Scanner buttons - change to grid */
           .controls {
               display: grid;
               grid-template-columns: 1fr 1fr;
               gap: 0.5rem;
           }
           
           .controls button {
               width: 100%;
               margin: 0 !important;
               font-size: 0.875rem;
               padding: 0.5rem;
           }
           
           /* Scanner container */
           #scanner-container {
               height: 300px !important;
               max-width: 100% !important;
           }
           
           /* Alerts */
           .alert {
               font-size: 0.875rem;
               padding: 0.75rem;
           }
           
           /* Form improvements */
           .form-row {
               flex-direction: column;
               gap: 15px;
           }

           .form-actions {
               flex-direction: column;
           }

           .product-form {
               padding: 15px;
               margin-top: 20px;
           }
           
           .product-form h2 {
               font-size: 1.25rem;
               margin-bottom: 15px;
           }
           
           .product-form .form-group {
               margin-bottom: 15px;
           }
           
           .product-form label {
               font-size: 0.9rem;
           }
           
           .product-form input,
           .product-form select {
               font-size: 0.9rem;
               padding: 0.5rem;
           }
           
           .product-form button {
               width: 100%;
               padding: 0.75rem;
               font-size: 1rem;
           }
           
           /* Chat window */
           #chatWindow {
               width: 90vw;
               right: 5vw;
           }
           
           .card-body {
               height: 300px !important;
           }
           
           /* Modal improvements */
           #cameraModal > div {
               width: 95% !important;
               padding: 20px;
           }
           
           /* Container padding */
           .container-fluid {
               padding-left: 0.75rem !important;
               padding-right: 0.75rem !important;
           }
           
           .main-content .col-12.p-3 {
               padding: 0.5rem !important;
           }
       }
       
       /* Extra small devices */
       @media (max-width: 576px) {
           .controls button {
               font-size: 0.8rem;
               padding: 0.4rem;
           }
           
           #scanner-container {
               height: 250px !important;
           }
           
           .product-form {
               padding: 10px;
           }
       }
    </style>
</head>

<body>

    <nav class="navbar navbar-dark bg-primary sticky-top">
       <div class="container-fluid">
        <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#menuSidebar" aria-controls="menuSidebar">
          <span class="navbar-toggler-icon"></span>
        </button>
        <a class="navbar-brand d-flex align-items-center" href="index.html">
          <img src="media_files/gategroup_logo.jpg" alt="Gategroup Logo" height="28" class="me-2" style="object-fit: contain;">
          <span class="fw-bold" style="font-size: 1.25rem; letter-spacing: 0.02em; margin-top: -3px;">Smart Plate</span>
        </a>
      </div>
    </nav>

    <div class="offcanvas offcanvas-start" tabindex="-1" id="menuSidebar" aria-labelledby="menuSidebarLabel">
       <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="menuSidebarLabel">Menu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="nav flex-column nav-pills">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" data-bs-toggle="dropdown" href="#" role="button" aria-expanded="false">
              Expiration
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item active" aria-current="page" href="exp_adding.html">Exp - Adding</a></li>
              <li><a class="dropdown-item" href="exp_dashboard.html">Exp - Dashboard</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="pre_flight_predictions.html">Pre-Flight Predictions</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#">Other Link</a>
          </li>
        </ul>
      </div>
    </div>

    <div class="container-fluid mt-4 main-content">
      <!-- Header Section -->
      <div class="row mb-4">
        <div class="col-12">
          <div class="header-gradient p-4 rounded-4 shadow-sm mb-4">
            <div>
              <h1 class="text-white mb-2 fw-bold">
                <i class="fas fa-qrcode me-2"></i>Add Products
              </h1>
              <p class="text-white-50 mb-0">Scan barcodes and manage your inventory</p>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-12 p-3">
          <!-- Barcode Scanner Section -->
          <div class="scanner-container-wrapper">
            <h2 class="text-center mb-4" style="color: #070769;">📷 Barcode Scanner</h2>
            
            <div class="controls text-center mb-4">
              <button id="startBtn" class="btn btn-primary me-2 mb-2">
                <i class="fas fa-play me-2"></i>Start Scanner
              </button>
              <button id="stopBtn" class="btn btn-danger me-2 mb-2" disabled>
                <i class="fas fa-stop me-2"></i>Stop Scanner
              </button>
              <button id="cameraBtn" class="btn me-2 mb-2" style="background: #0d0d9c; color: white;">
                <i class="fas fa-camera me-2"></i>Select Camera
              </button>
              <button id="historyBtn" class="btn mb-2" style="background: #0d0d9c; color: white;">
                <i class="fas fa-history me-2"></i>Show History
              </button>
            </div>
            
            <div id="status" class="alert alert-info text-center mb-3">Scanner stopped</div>
            
            <div id="scanner-container" class="mx-auto mb-4" style="width: 100%; max-width: 700px; height: 500px; position: relative; border: 3px solid #E1F1F6; border-radius: 15px; overflow: hidden; background: #000; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
              <!-- Visual guide showing the actual scan area -->
              <div class="scan-area-overlay" id="scanAreaOverlay"></div>
            </div>
            
            <div id="result" class="alert alert-success" style="display: none;">
              <strong>Detected Barcode:</strong> <span id="barcodeResult"></span>
            </div>
            
            <div id="error" class="alert alert-danger" style="display: none;">
              <strong>Error:</strong> <span id="errorMessage"></span>
            </div>
            
            <div id="history" class="alert alert-light" style="display: none;">
              <strong>Detection History:</strong>
              <div id="historyContent"></div>
            </div>

            <!-- Product Information Form -->
            <div class="product-form">
                <h2 style="color: #070769; margin-bottom: 20px;">Product Information</h2>
                <form id="productForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="barcode">Barcode:</label>
                            <input type="text" id="barcode" name="barcode" readonly>
          </div>
                        <div class="form-group">
                            <label for="productID">ProductID:</label>
                            <input type="text" id="productID" name="productID" placeholder="Auto-filled if exists">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="productName">Product Name:</label>
                            <input type="text" id="productName" name="productName" placeholder="Auto-filled if exists">
                        </div>
                        <div class="form-group">
                            <label for="lot">Lot#:</label>
                            <input type="text" id="lot" name="lot" placeholder="Enter lot number">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="quantity">Quantity:</label>
                            <input type="number" id="quantity" name="quantity" min="1" placeholder="Enter quantity">
                        </div>
                        <div class="form-group">
                            <label for="expirationDate">Expiration Date:</label>
                            <input type="date" id="expirationDate" name="expirationDate">
                        </div>
                    </div>
                     <div class="form-actions" style="display: flex; justify-content: center;">
                         <!-- Link Barcode button - code remains but hidden -->
                         <button type="button" id="linkBtn" class="btn link-btn" style="display: none;">Link Barcode</button>
                         <button type="button" id="saveBtn" class="btn save-btn" style="max-width: 300px; width: 100%;">Save Product</button>
                     </div>
                </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Camera Selection Modal -->
    <div id="cameraModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(7, 7, 105, 0.8); z-index: 1000;">
      <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
        <h3 style="margin-top: 0; color: #070769;">Select Camera</h3>
        <div id="cameraList"></div>
        <div style="margin-top: 20px; text-align: right;">
          <button id="cancelCamera" class="btn btn-secondary">Cancel</button>
        </div>
      </div>
    </div>

    <button class="btn btn-primary btn-lg rounded-circle shadow" type="button" id="chatButton" data-bs-toggle="collapse" data-bs-target="#chatWindow" aria-expanded="false" aria-controls="chatWindow">
      <img src="media_files/gemini_logo.png" alt="Gemini Logo" width="30" height="30" style="filter: brightness(0) invert(1);">
    </button>
    <div class="collapse" id="chatWindow">
       <div class="card shadow-lg">
          <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
           <span>Chat Assistant</span>
           <button type="button" class="btn-close btn-close-white" data-bs-toggle="collapse" data-bs-target="#chatWindow" aria-label="Close"></button>
         </div>
         <div class="card-body" id="chatBody" style="height: 400px; overflow-y: scroll;">
           <p><b>Assistant:</b> Hello! How can I help you?</p>
         </div>
         <div class="card-footer d-flex">
           <input type="text" id="chatInput" class="form-control" placeholder="Type your message...">
           <button class="btn btn-primary ms-2" id="sendMessageButton">Send</button>
         </div>
       </div>
    </div>

    <footer class="bg-dark text-white p-5">
      <div class="container">
         <div class="row">
          <div class="col-md-3 mb-4">
            <h5 class="mb-3">Smart Plate</h5>
            <p class="text-white-50">Copyright &copy; 2025 Gategroup. <br>All rights reserved.</p>
          </div>
          <div class="col-md-3 mb-4">
            <h5>Explore</h5>
            <ul class="nav flex-column">
              <li class="nav-item mb-2"><a href="index.html" class="nav-link p-0 text-white-50">Home</a></li>
              <li class="nav-item mb-2"><a href="exp_dashboard.html" class="nav-link p-0 text-white-50">Dashboard</a></li>
              <li class="nav-item mb-2"><a href="pre_flight_predictions.html" class="nav-link p-0 text-white-50">Predictions</a></li>
              <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-white-50">About Us</a></li>
            </ul>
          </div>
          <div class="col-md-3 mb-4">
            <h5>Global Headquarters</h5>
            <address class="text-white-50" style="font-style: normal;">
              Gategroup<br>
              Street Address 123<br>
              Zurich, Switzerland
            </address>
          </div>
          <div class="col-md-3 mb-4">
            <h5>Legal</h5>
            <ul class="nav flex-column">
              <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-white-50">Terms & Conditions</a></li>
              <li class="nav-item mb-2"><a href="#" class="nav-link p-0 text-white-50">Data Privacy</a></li>
            </ul>
          </div>
        </div>
      </div>
    </footer>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Include QuaggaJS script -->
    <script src="https://cdn.rawgit.com/serratus/quaggaJS/0420d5e0/dist/quagga.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
      // Barcode Scanner JavaScript
      // Global variables
      let isScanning = false;
      let availableCameras = [];
      let selectedCameraId = null;
      
      // DOM elements
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const cameraBtn = document.getElementById('cameraBtn');
      const historyBtn = document.getElementById('historyBtn');
      const status = document.getElementById('status');
      const result = document.getElementById('result');
      const error = document.getElementById('error');
      const history = document.getElementById('history');
      const barcodeResult = document.getElementById('barcodeResult');
      const errorMessage = document.getElementById('errorMessage');
      const historyContent = document.getElementById('historyContent');
      const cameraModal = document.getElementById('cameraModal');
      const cameraList = document.getElementById('cameraList');
      const cancelCamera = document.getElementById('cancelCamera');
      
      // Form elements
      const barcodeInput = document.getElementById('barcode');
      const productIDInput = document.getElementById('productID');
      const productNameInput = document.getElementById('productName');
      const lotInput = document.getElementById('lot');
      const quantityInput = document.getElementById('quantity');
      const expirationDateInput = document.getElementById('expirationDate');
      const linkBtn = document.getElementById('linkBtn');
      const saveBtn = document.getElementById('saveBtn');
      
      // Event listeners
      startBtn.addEventListener('click', startScanner);
      stopBtn.addEventListener('click', stopScanner);
      cameraBtn.addEventListener('click', showCameraSelection);
      historyBtn.addEventListener('click', toggleHistory);
      cancelCamera.addEventListener('click', hideCameraModal);
      linkBtn.addEventListener('click', handleLinkBarcode);
      saveBtn.addEventListener('click', handleSaveProduct);
      
      function updateStatus(message, type) {
          status.textContent = message;
          status.className = `alert alert-${type === 'scanning' ? 'primary' : type === 'error' ? 'danger' : 'info'} text-center mb-3`;
      }
      
      function showResult(code) {
          barcodeResult.textContent = code;
          result.style.display = 'block';
          error.style.display = 'none';
          
          // Autofill barcode field
          barcodeInput.value = code;
          
          // Check backend for product information
          checkBarcodeInDatabase(code);
      }

      async function checkBarcodeInDatabase(barcode) {
          try {
              const response = await fetch('/api/check_barcode', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ barcode: barcode })
              });
              
              const data = await response.json();
              
              if (data.exists) {
                  // Product exists - autofill ONLY ProductID and Product Name
                  productIDInput.value = data.productID || '';
                  productNameInput.value = data.productName || '';
                  
                  // DO NOT autofill lot, quantity, or expiration date - leave them empty for new entries
                  lotInput.value = '';
                  quantityInput.value = '';
                  expirationDateInput.value = '';
                  
                  updateStatus('✅ Product found - Fill in Lot#, Quantity, and Expiration Date', 'scanning');
              } else {
                  // Product doesn't exist
                  productIDInput.value = '';
                  productNameInput.value = '';
                  productIDInput.placeholder = 'Does not Exist';
                  productNameInput.placeholder = 'Does not Exist';
                  updateStatus('❌ Product not found in database', 'error');
              }
          } catch (error) {
              console.error('Error checking barcode:', error);
              updateStatus('Error checking database', 'error');
          }
      }

      function handleLinkBarcode() {
          const barcode = barcodeInput.value;
          const productID = productIDInput.value;
          const productName = productNameInput.value;
          
          if (!barcode) {
              alert('Please scan a barcode first');
              return;
          }
          
          if (!productID || !productName) {
              alert('Please enter ProductID and Product Name to link');
              return;
          }
          
          // Clear any "No existe" placeholders
          productIDInput.placeholder = 'Auto-filled if exists';
          productNameInput.placeholder = 'Auto-filled if exists';
          
          updateStatus('Barcode linked to ProductID and Product Name', 'stopped');
      }

      async function handleSaveProduct() {
          const barcode = barcodeInput.value;
          const productID = productIDInput.value;
          const productName = productNameInput.value;
          const lot = lotInput.value;
          const quantity = parseInt(quantityInput.value) || 0;
          const expirationDate = expirationDateInput.value;
          
          if (!barcode) {
              alert('Please scan a barcode first');
              return;
          }
          
          if (!productID || !productName) {
              alert('Please enter ProductID and Product Name');
              return;
          }
          
          if (!quantity || quantity <= 0) {
              alert('Please enter a valid quantity');
              return;
          }
          
          if (!expirationDate) {
              alert('Please enter an expiration date');
              return;
          }
          
          try {
              updateStatus('Saving product...', 'scanning');
              
              const response = await fetch('/api/save_product', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                      barcode: barcode,
                      productID: productID,
                      productName: productName,
                      quantity: quantity,
                      lot: lot,
                      expirationDate: expirationDate
                  })
              });
              
              const data = await response.json();
              
              if (data.success) {
                  alert('Product saved successfully!');
                  updateStatus('Product saved successfully', 'stopped');
                  clearForm();
              } else {
                  alert('Error saving product: ' + data.message);
                  updateStatus('Error saving product', 'error');
              }
          } catch (error) {
              console.error('Error saving product:', error);
              alert('Error saving product');
              updateStatus('Error saving product', 'error');
          }
      }

      function clearForm() {
          barcodeInput.value = '';
          productIDInput.value = '';
          productNameInput.value = '';
          lotInput.value = '';
          quantityInput.value = '';
          expirationDateInput.value = '';
      }
      
      function showError(message) {
          errorMessage.textContent = message;
          error.style.display = 'block';
          result.style.display = 'none';
      }
      
      function hideMessages() {
          result.style.display = 'none';
          error.style.display = 'none';
      }
      
      function toggleHistory() {
          if (history.style.display === 'none') {
              showHistory();
          } else {
              hideHistory();
          }
      }
      
      function showHistory() {
          if (detectionHistory.length === 0) {
              historyContent.innerHTML = '<p>No detections yet</p>';
          } else {
              let html = '<ul>';
              detectionHistory.forEach((item, index) => {
                  const time = new Date(item.timestamp).toLocaleTimeString();
                  html += `<li><strong>${item.code}</strong> - Confidence: ${(item.confidence * 100).toFixed(1)}% - ${time}</li>`;
              });
              html += '</ul>';
              historyContent.innerHTML = html;
          }
          history.style.display = 'block';
          historyBtn.textContent = 'Hide History';
      }
      
      function hideHistory() {
          history.style.display = 'none';
          historyBtn.textContent = 'Show History';
      }
      
      async function showCameraSelection() {
          try {
              updateStatus('Loading cameras...', 'scanning');
              
              // Get available cameras
              const devices = await navigator.mediaDevices.enumerateDevices();
              availableCameras = devices.filter(device => device.kind === 'videoinput');
              
              if (availableCameras.length === 0) {
                  showError('No cameras found');
                  updateStatus('Error: No cameras available', 'error');
                  return;
              }
              
              // Build camera list
              let html = '';
              availableCameras.forEach((camera, index) => {
                  const label = camera.label || `Camera ${index + 1}`;
                  const isSelected = selectedCameraId === camera.deviceId ? 'checked' : '';
                  html += `
                      <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                          <input type="radio" name="camera" value="${camera.deviceId}" id="camera_${index}" ${isSelected}>
                          <label for="camera_${index}" style="margin-left: 10px; cursor: pointer;">${label}</label>
                      </div>
                  `;
              });
              
              cameraList.innerHTML = html;
              
              // Add event listeners to radio buttons
              const radioButtons = cameraList.querySelectorAll('input[name="camera"]');
              radioButtons.forEach(radio => {
                  radio.addEventListener('change', function() {
                      selectedCameraId = this.value;
                      console.log('Selected camera:', this.value);
                      hideCameraModal();
                      updateStatus(`Camera selected: ${this.nextElementSibling.textContent}`, 'stopped');
                  });
              });
              
              cameraModal.style.display = 'block';
              updateStatus('Select a camera from the list', 'stopped');
              
          } catch (error) {
              console.error('Error getting cameras:', error);
              showError(`Error accessing cameras: ${error.message}`);
              updateStatus('Error: Cannot access cameras', 'error');
          }
      }
      
      function hideCameraModal() {
          cameraModal.style.display = 'none';
      }
      
      // Variables para estabilizar el reconocimiento
      let lastDetectedCode = '';
      let detectionCount = 0;
      let detectionHistory = [];
      const REQUIRED_CONSISTENT_DETECTIONS = 2; // Requerir 2 detecciones consistentes para respuesta más rápida
      const DETECTION_TIMEOUT = 2000; // 2 segundos para resetear
      
      function startScanner() {
          console.log('Starting QuaggaJS scanner...');
          updateStatus('Initializing scanner...', 'scanning');
          hideMessages();
          
          // Reset detection variables
          lastDetectedCode = '';
          detectionCount = 0;
          detectionHistory = [];
          
          // Check if QuaggaJS is available
          if (typeof Quagga === 'undefined') {
              showError('QuaggaJS library not loaded');
              updateStatus('Error: QuaggaJS not available', 'error');
              return;
          }
          
          // Check camera support
          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
              showError('Camera API not supported in this browser');
              updateStatus('Error: Camera not supported', 'error');
              return;
          }
          
          // Build constraints with selected camera
          const constraints = {
              width: { ideal: 1280, max: 1280 },
              height: { ideal: 720, max: 720 },
              facingMode: "environment",
              frameRate: { ideal: 10, max: 10 },  // Back to 10 FPS
              aspectRatio: { ideal: 16/9 }
          };
          
          // Add deviceId if a specific camera is selected
          if (selectedCameraId) {
              constraints.deviceId = { exact: selectedCameraId };
              console.log('Using selected camera:', selectedCameraId);
          }
          
          const config = {
              inputStream: {
                  name: "Live",
                  type: "LiveStream",
                  target: document.querySelector('#scanner-container'),
                  constraints: constraints,
                  area: { // Área de escaneo expandida para mejor detección
                      top: "20%",
                      right: "20%",
                      left: "20%",
                      bottom: "20%"
                  }
              },
              decoder: {
                  readers: [
                      "ean_reader",           // EAN-13, EAN-8
                  ],
                  debug: {
                      drawBoundingBox: false,
                      showFrequency: false,
                      drawScanline: false,
                      showPattern: false
                  }
              },
              locate: true,
              locator: {
                  halfSample: true,
                  patchSize: "large", // Patch más grande para mejor detección
                  showCanvas: false,
                  showPatches: false,
                  showFoundPatches: false,
                  showSkeleton: false,
                  showLabels: false,
                  showPatchLabels: false,
                  showBoundingBox: false,
                  showScanningRegion: false
              },
              frequency: 3 // Aumentar frecuencia para mejor detección
          };
          
          console.log('QuaggaJS config:', config);
          
          Quagga.init(config, function(err) {
              if (err) {
                  console.error('QuaggaJS initialization error:', err);
                  showError(`Initialization failed: ${err.message || err}`);
                  updateStatus('Error: Initialization failed', 'error');
                  return;
              }
              
              console.log("QuaggaJS initialized successfully.");
              updateStatus('Scanner running - Point camera at barcode', 'scanning');
              
              // Show scan area overlay when scanner starts
              const scanOverlay = document.getElementById('scanAreaOverlay');
              if (scanOverlay) {
                  scanOverlay.style.display = 'block';
              }
              
              // Start scanning
              Quagga.start();
              isScanning = true;
              
              // Verificar framerate real de la cámara
              setTimeout(() => {
                  const videoElement = document.querySelector('video');
                  if (videoElement) {
                      console.log('Video element found, checking framerate...');
                      console.log('Video dimensions:', videoElement.videoWidth, 'x', videoElement.videoHeight);
                      
                      // Intentar obtener información del stream
                      const stream = videoElement.srcObject;
                      if (stream) {
                          const videoTrack = stream.getVideoTracks()[0];
                          if (videoTrack) {
                              const settings = videoTrack.getSettings();
                              console.log('Camera settings:', settings);
                              console.log('Actual framerate:', 10);
                              
                              if (settings.frameRate) {
                                  updateStatus(`Scanner running - Framerate: ${settings.frameRate}fps`, 'scanning');
                              }
                          }
                      }
                  }
              }, 1000);
              
              // Update buttons
              startBtn.disabled = true;
              stopBtn.disabled = false;
          });
          
          // Handle barcode detection with stabilization
          Quagga.onDetected(function(result) {
              const code = result.codeResult.code;
              const confidence = result.codeResult.decodedCodes ? 
                  result.codeResult.decodedCodes.reduce((acc, curr) => acc + (1 - curr.error), 0) / result.codeResult.decodedCodes.length : 0;
              
              console.log("Barcode detected:", code, "Confidence:", confidence);
              
              // Solo procesar códigos con confianza aceptable (reducido para mejor detección)
              if (confidence < 0.5) {
                  console.log("Low confidence detection, ignoring:", code);
                  return;
              }
              
              // Verificar si es el mismo código que antes
              if (code === lastDetectedCode) {
                  detectionCount++;
                  console.log(`Same code detected ${detectionCount} times:`, code);
                  
                  // Si hemos detectado el mismo código varias veces, mostrarlo
                  if (detectionCount >= REQUIRED_CONSISTENT_DETECTIONS) {
                      showResult(code);
                      updateStatus(`Barcode confirmed: ${code}`, 'scanning');
                      
                      // Opcional: parar después de confirmación
                      // stopScanner();
                  }
              } else {
                  // Nuevo código detectado
                  lastDetectedCode = code;
                  detectionCount = 1;
                  console.log("New code detected:", code);
                  
                  // Agregar a historial para análisis
                  detectionHistory.push({
                      code: code,
                      timestamp: Date.now(),
                      confidence: confidence
                  });
                  
                  // Mantener solo los últimos 10
                  if (detectionHistory.length > 10) {
                      detectionHistory.shift();
                  }
              }
              
              // Resetear contador después de un tiempo
              setTimeout(() => {
                  if (detectionCount > 0) {
                      detectionCount = 0;
                      lastDetectedCode = '';
                  }
              }, DETECTION_TIMEOUT);
          });
      }
      
      function stopScanner() {
          if (isScanning) {
              console.log('Stopping QuaggaJS scanner...');
              Quagga.stop();
              isScanning = false;
              
              updateStatus('Scanner stopped', 'stopped');
              
              // Hide scan area overlay when scanner stops
              const scanOverlay = document.getElementById('scanAreaOverlay');
              if (scanOverlay) {
                  scanOverlay.style.display = 'none';
              }
              
              // Update buttons
              startBtn.disabled = false;
              stopBtn.disabled = true;
          }
      }
      
      // Cleanup on page unload
      window.addEventListener('beforeunload', function() {
          if (isScanning) {
              Quagga.stop();
          }
      });
      
      // Initialize default camera on page load
      async function initializeDefaultCamera() {
          try {
              const devices = await navigator.mediaDevices.enumerateDevices();
              const cameras = devices.filter(device => device.kind === 'videoinput');
              
              if (cameras.length > 0) {
                  // Try to find rear camera first (environment facing)
                  const rearCamera = cameras.find(camera => 
                      camera.label.toLowerCase().includes('rear') || 
                      camera.label.toLowerCase().includes('back') ||
                      camera.label.toLowerCase().includes('environment')
                  );
                  
                  if (rearCamera) {
                      selectedCameraId = rearCamera.deviceId;
                      console.log('Auto-selected rear camera:', rearCamera.label);
                      updateStatus(`Auto-selected: ${rearCamera.label}`, 'stopped');
                  } else {
                      // Fallback to first camera
                      selectedCameraId = cameras[0].deviceId;
                      console.log('Auto-selected first camera:', cameras[0].label);
                      updateStatus(`Auto-selected: ${cameras[0].label}`, 'stopped');
                  }
              } else {
                  updateStatus('No cameras found - Click "Select Camera"', 'stopped');
              }
          } catch (error) {
              console.error('Error initializing camera:', error);
              updateStatus('Error accessing cameras', 'error');
          }
      }
      
      // Request camera permission on page load
      async function requestCameraPermission() {
          try {
              // Request access to camera to get permission popup
              const stream = await navigator.mediaDevices.getUserMedia({ 
                  video: { 
                      facingMode: "environment" 
                  } 
              });
              
              // Stop the stream immediately after getting permission
              stream.getTracks().forEach(track => track.stop());
              
              console.log('Camera permission granted');
              updateStatus('Camera permission granted - Ready to scan', 'stopped');
              
              // Now initialize the default camera
              initializeDefaultCamera();
          } catch (error) {
              console.error('Error requesting camera permission:', error);
              updateStatus('Camera permission denied - Click "Start Scanner" to try again', 'error');
              initializeDefaultCamera();
          }
      }
      
      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
          updateStatus('Requesting camera permission...', 'scanning');
          requestCameraPermission();
      });
      
      // Initial status
      updateStatus('Loading cameras...', 'stopped');
      
      // Bootstrap page show handler
      window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
          window.location.reload();
        }
      });

      // Chat functionality
      //DOM elements
      const chatSendButton = document.getElementById('sendMessageButton');
      const chatInput = document.getElementById('chatInput');
      const chatBody = document.getElementById('chatBody');

      // Initialize chat when document is loaded
      document.addEventListener('DOMContentLoaded', function() {
          // Chat is ready - no need for initChat function
          console.log('Chat initialized');
      });

      // Function to add a message to the chat body
      function addChatMessage(sender, message) {
          const messageElement = document.createElement('p');
          // Basic formatting - sanitize message slightly
          const cleanMessage = message.replace(/</g, "&lt;").replace(/>/g, "&gt;");
          messageElement.innerHTML = `<b>${sender}:</b> ${cleanMessage}`;
          chatBody.appendChild(messageElement);
          // Scroll to the bottom
          chatBody.scrollTop = chatBody.scrollHeight;
      }

      // Function to handle sending a message
      async function sendChatMessage() {
          const userMessage = chatInput.value.trim();
          if (!userMessage) return; // Don't send empty messages

          // 1. Display user message immediately
          addChatMessage('You', userMessage);
          chatInput.value = ''; // Clear input
          chatSendButton.disabled = true; // Disable button while waiting

          // 2. Send message to backend
          try {
              const response = await fetch('/api/chat', {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({ message: userMessage }),
              });

              if (!response.ok) {
                  // Try to get error detail from backend response if available
                  let errorDetail = `HTTP error! status: ${response.status}`;
                  try {
                      const errorData = await response.json();
                      if (errorData.detail) {
                         errorDetail = errorData.detail;
                      }
                  } catch (e) { /* Ignore if response is not JSON */ }
                  throw new Error(errorDetail);
              }

              const data = await response.json();

              // 3. Display assistant's reply
              addChatMessage('Assistant', data.reply);

          } catch (error) {
              console.error('Error sending chat message:', error);
              // Display the specific error message from fetch or backend
              addChatMessage('System', `Sorry, I encountered an error: ${error.message}`);
          } finally {
               chatSendButton.disabled = false; // Re-enable button
               chatInput.focus(); // Focus input for next message
          }
      }

      // Event listener for the send button
      chatSendButton.addEventListener('click', sendChatMessage);

      // Event listener for pressing Enter in the input field
      chatInput.addEventListener('keypress', function (e) {
          if (e.key === 'Enter') {
              sendChatMessage();
        }
      });
    </script>

</body>
</html>