<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        #scanner-container {
            position: relative;
            width: 100%;
            height: 300px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }
        
        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scanner-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 100px;
            border: 2px solid #10b981;
            border-radius: 8px;
            background: rgba(16, 185, 129, 0.1);
            pointer-events: none;
        }
        
        .scanner-overlay::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid #10b981;
            border-radius: 8px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .success-border {
            border-color: #10b981 !important;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.3) !important;
        }
        
        .error-border {
            border-color: #ef4444 !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3) !important;
        }
        
        .form-field {
            transition: all 0.3s ease;
        }
        
        .loading {
            display: none !important;
        }
        
        .loading.show {
            display: flex !important;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-md">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Barcode Scanner</h1>
            <p class="text-gray-600">Scan product barcode to get started</p>
        </div>

        <!-- Scanner Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <!-- Camera Selection -->
            <div class="mb-4">
                <label for="cameraSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Camera</label>
                <select id="cameraSelect" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">Loading cameras...</option>
                </select>
            </div>
            
            <div class="mb-4">
                <button id="startScanner" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors" style="display: none;">
                    Restart Scanner
                </button>
                <button id="stopScanner" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors mt-2" style="display: none;">
                    Stop Scanner
                </button>
            </div>
            
            <div id="scanner-container" style="display: none;">
                <div class="scanner-overlay"></div>
            </div>
            
            <div id="scanner-status" class="text-center text-sm text-gray-600 mt-2"></div>
        </div>

        <!-- Product Form -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Product Information</h2>
            
            <form id="productForm" class="space-y-4">
                <!-- Barcode -->
                <div>
                    <label for="barcode" class="block text-sm font-medium text-gray-700 mb-1">Barcode</label>
                    <input type="text" id="barcode" name="barcode" readonly 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 form-field">
                </div>

                <!-- Product ID -->
                <div>
                    <label for="productId" class="block text-sm font-medium text-gray-700 mb-1">Product ID</label>
                    <input type="text" id="productId" name="productId" readonly 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 form-field">
                </div>

                <!-- Product Name -->
                <div>
                    <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                    <input type="text" id="productName" name="productName" readonly 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 form-field">
                </div>

                <!-- Lot Number -->
                <div>
                    <label for="lotNumber" class="block text-sm font-medium text-gray-700 mb-1">Lot Number *</label>
                    <input type="text" id="lotNumber" name="lotNumber" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-field"
                           placeholder="Enter lot number">
                </div>

                <!-- Quantity -->
                <div>
                    <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity *</label>
                    <input type="number" id="quantity" name="quantity" required min="1" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-field"
                           placeholder="Enter quantity">
                </div>

                <!-- Expiration Date -->
                <div>
                    <label for="expirationDate" class="block text-sm font-medium text-gray-700 mb-1">Expiration Date *</label>
                    <input type="date" id="expirationDate" name="expirationDate" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 form-field">
                </div>

                <!-- Action Buttons -->
                <div class="space-y-3">
                    <button type="submit" id="saveProduct" 
                            class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                            disabled>
                        Save Product
                    </button>
                    
                    <button type="button" id="linkBarcode" 
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
                            disabled>
                        Link Barcode to Product
                    </button>
                </div>
            </form>
        </div>

        <!-- Status Messages -->
        <div id="status" class="mt-6 text-center text-sm"></div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg p-6 text-center">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-700">Processing...</p>
            </div>
        </div>
    </div>

    <script>
        let scannerActive = false;
        let currentStream = null;
        let availableCameras = [];

        // DOM Elements
        const startBtn = document.getElementById('startScanner');
        const stopBtn = document.getElementById('stopScanner');
        const scannerContainer = document.getElementById('scanner-container');
        const scannerStatus = document.getElementById('scanner-status');
        const productForm = document.getElementById('productForm');
        const statusDiv = document.getElementById('status');
        const loadingDiv = document.getElementById('loading');
        const saveBtn = document.getElementById('saveProduct');
        const linkBtn = document.getElementById('linkBarcode');
        const cameraSelect = document.getElementById('cameraSelect');

        // Form fields
        const barcodeField = document.getElementById('barcode');
        const productIdField = document.getElementById('productId');
        const productNameField = document.getElementById('productName');
        const lotNumberField = document.getElementById('lotNumber');
        const quantityField = document.getElementById('quantity');
        const expirationDateField = document.getElementById('expirationDate');

        // Start scanner
        startBtn.addEventListener('click', async () => {
            try {
                await startCameraScanner();
            } catch (error) {
                console.error('Camera error:', error);
                showStatus('Camera not available. Please check permissions.', 'error');
                speakText('Camera not available');
            }
        });

        // Stop scanner
        stopBtn.addEventListener('click', () => {
            stopCameraScanner();
        });

        // Form submission
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveProduct();
        });

        // Link barcode button
        linkBtn.addEventListener('click', async () => {
            await linkBarcodeToProduct();
        });

        // Form validation
        lotNumberField.addEventListener('input', validateForm);
        quantityField.addEventListener('input', validateForm);
        expirationDateField.addEventListener('input', validateForm);

        // Camera selection change
        cameraSelect.addEventListener('change', function() {
            if (scannerActive) {
                stopCameraScanner();
            }
        });

        // Load available cameras on page load
        async function loadCameras() {
            try {
                showStatus('Requesting camera access...', 'info');
                
                // First request basic camera access to get device labels
                let stream;
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    // Stop the basic stream immediately
                    stream.getTracks().forEach(track => track.stop());
                } catch (error) {
                    showStatus('Camera access denied. Please allow camera permissions and refresh the page.', 'error');
                    speakText('Camera access denied. Please allow camera permissions');
                    cameraSelect.innerHTML = '<option value="">Camera access denied</option>';
                    return;
                }
                
                showStatus('Camera access granted. Loading cameras...', 'success');
                
                // Now enumerate devices with proper labels
                const devices = await navigator.mediaDevices.enumerateDevices();
                availableCameras = devices.filter(device => device.kind === 'videoinput');
                
                cameraSelect.innerHTML = '';
                
                if (availableCameras.length === 0) {
                    cameraSelect.innerHTML = '<option value="">No cameras found</option>';
                    showStatus('No cameras detected', 'error');
                    return;
                }
                
                availableCameras.forEach((camera, index) => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    option.textContent = camera.label || `Camera ${index + 1}`;
                    cameraSelect.appendChild(option);
                });
                
                // Select the first camera by default and auto-start
                if (availableCameras.length > 0) {
                    cameraSelect.value = availableCameras[0].deviceId;
                    showStatus('Camera ready. Starting scanner automatically...', 'success');
                    
                    // Auto-start the scanner after a short delay
                    setTimeout(() => {
                        startCameraScanner();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Error loading cameras:', error);
                cameraSelect.innerHTML = '<option value="">Error loading cameras</option>';
                showStatus('Error loading cameras', 'error');
                speakText('Error loading cameras');
            }
        }

        async function startCameraScanner() {
            try {
                showStatus('Initializing scanner...', 'info');
                
                const selectedCameraId = cameraSelect.value;
                if (!selectedCameraId) {
                    showStatus('Please select a camera first', 'error');
                    speakText('Please select a camera first');
                    return;
                }
                
                const constraints = {
                    video: {
                        deviceId: { exact: selectedCameraId },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);

                currentStream = stream;
                scannerContainer.style.display = 'block';
                scannerContainer.innerHTML = `
                    <video id="scanner-video" autoplay muted playsinline></video>
                    <div class="scanner-overlay"></div>
                `;

                const video = document.getElementById('scanner-video');
                video.srcObject = stream;

                // Initialize QuaggaJS
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: video,
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment"
                        }
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true
                    },
                    numOfWorkers: 2,
                    frequency: 10,
                    decoder: {
                        readers: [
                            "ean_reader",
                            "ean_8_reader",
                            "code_128_reader",
                            "upc_reader",
                            "upc_e_reader"
                        ]
                    },
                    locate: true
                }, (err) => {
                    if (err) {
                        console.error('QuaggaJS error:', err);
                        showStatus('Scanner initialization failed', 'error');
                        speakText('Scanner initialization failed');
                        return;
                    }
                    
                    scannerActive = true;
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'block';
                    showStatus('Scanner active - Point camera at barcode', 'success');
                    
                    Quagga.start();
                });

                Quagga.onDetected((data) => {
                    if (scannerActive) {
                        const code = data.codeResult.code;
                        console.log('Barcode detected:', code);
                        
                        // Visual feedback
                        scannerContainer.classList.add('success-border');
                        setTimeout(() => {
                            scannerContainer.classList.remove('success-border');
                        }, 1000);
                        
                        processBarcode(code);
                    }
                });

            } catch (error) {
                console.error('Camera access error:', error);
                showStatus('Camera not available. Please check permissions.', 'error');
                speakText('Camera not available');
            }
        }

        function stopCameraScanner() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
            }
            
            scannerContainer.style.display = 'none';
            startBtn.style.display = 'block';
            stopBtn.style.display = 'none';
            showStatus('Scanner stopped. Click "Restart Scanner" to resume.', 'info');
        }

        async function processBarcode(barcode) {
            try {
                showLoading(true);
                showStatus('Checking barcode...', 'info');
                
                const response = await fetch('/check_barcode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ barcode: barcode })
                });

                const data = await response.json();
                
                if (data.found) {
                    barcodeField.value = barcode;
                    productIdField.value = data.product_id;
                    productNameField.value = data.name;
                    
                    // Enable form fields for editing
                    lotNumberField.readOnly = false;
                    lotNumberField.classList.remove('bg-gray-50');
                    quantityField.readOnly = false;
                    quantityField.classList.remove('bg-gray-50');
                    expirationDateField.readOnly = false;
                    expirationDateField.classList.remove('bg-gray-50');
                    
                    showStatus('Product found! Please fill remaining fields.', 'success');
                    speakText('Product found');
                    validateForm();
                } else {
                    showStatus('Product not found. Please enter Product ID and Name, then click "Link Barcode to Product"', 'warning');
                    speakText('Product not found, please enter product information');
                    
                    // Clear form
                    barcodeField.value = barcode;
                    productIdField.value = '';
                    productNameField.value = '';
                    
                    // Enable fields for manual entry
                    productIdField.readOnly = false;
                    productIdField.classList.remove('bg-gray-50');
                    productNameField.readOnly = false;
                    productNameField.classList.remove('bg-gray-50');
                    
                    // Keep batch fields disabled until product is linked
                    lotNumberField.readOnly = true;
                    lotNumberField.classList.add('bg-gray-50');
                    quantityField.readOnly = true;
                    quantityField.classList.add('bg-gray-50');
                    expirationDateField.readOnly = true;
                    expirationDateField.classList.add('bg-gray-50');
                    
                    validateForm();
                }
            } catch (error) {
                console.error('Error processing barcode:', error);
                showStatus('Error checking barcode', 'error');
                speakText('Error checking barcode');
            } finally {
                showLoading(false);
            }
        }

        async function saveProduct() {
            try {
                showLoading(true);
                showStatus('Saving product...', 'info');
                
                const formData = {
                    barcode: barcodeField.value,
                    product_id: productIdField.value,
                    lot_number: lotNumberField.value,
                    quantity: parseInt(quantityField.value),
                    expiration_date: expirationDateField.value
                };

                const response = await fetch('/add_product_data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const data = await response.json();
                    showStatus('Product saved successfully!', 'success');
                    
                    // Generate description and speak it
                    await generateAndSpeakDescription(formData);
                    
                    // Reset form
                    resetForm();
                } else {
                    throw new Error('Failed to save product');
                }
            } catch (error) {
                console.error('Error saving product:', error);
                showStatus('Error saving product', 'error');
                speakText('Error saving product');
            } finally {
                showLoading(false);
            }
        }

        async function linkBarcodeToProduct() {
            try {
                showLoading(true);
                showStatus('Linking barcode to product...', 'info');
                
                const linkData = {
                    barcode: barcodeField.value,
                    product_id: productIdField.value,
                    name: productNameField.value
                };

                const response = await fetch('/link_barcode', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(linkData)
                });

                if (response.ok) {
                    const data = await response.json();
                    showStatus('Barcode linked successfully! Now you can fill batch information.', 'success');
                    speakText('Barcode linked successfully');
                    
                    // Enable batch fields for data entry
                    lotNumberField.readOnly = false;
                    lotNumberField.classList.remove('bg-gray-50');
                    quantityField.readOnly = false;
                    quantityField.classList.remove('bg-gray-50');
                    expirationDateField.readOnly = false;
                    expirationDateField.classList.remove('bg-gray-50');
                    
                    // Update button states
                    linkBtn.disabled = true;
                    validateForm();
                } else {
                    throw new Error('Failed to link barcode');
                }
            } catch (error) {
                console.error('Error linking barcode:', error);
                showStatus('Error linking barcode', 'error');
                speakText('Error linking barcode');
            } finally {
                showLoading(false);
            }
        }

        async function generateAndSpeakDescription(productData) {
            try {
                // Generate description
                const describeResponse = await fetch('/describe', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        barcode: productData.barcode,
                        name: productData.product_id,
                        quantity: productData.quantity,
                        expiration_date: productData.expiration_date
                    })
                });

                if (describeResponse.ok) {
                    const describeData = await describeResponse.json();
                    const description = describeData.description;
                    
                    // Speak the description
                    await speakText(description);
                }
            } catch (error) {
                console.error('Error generating description:', error);
            }
        }

        async function speakText(text) {
            try {
                const response = await fetch('/speak', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text })
                });

                if (response.ok) {
                    const audioBlob = await response.blob();
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);
                    await audio.play();
                    
                    // Clean up URL after playing
                    audio.onended = () => URL.revokeObjectURL(audioUrl);
                }
            } catch (error) {
                console.error('Error playing audio:', error);
            }
        }

        function validateForm() {
            const lotNumber = lotNumberField.value.trim();
            const quantity = quantityField.value;
            const expirationDate = expirationDateField.value;
            const productId = productIdField.value.trim();
            const productName = productNameField.value.trim();

            let isValid = true;

            // Validate lot number format (alphanumeric, 3-20 characters)
            if (lotNumber && !/^[A-Za-z0-9]{3,20}$/.test(lotNumber)) {
                lotNumberField.classList.add('error-border');
                isValid = false;
            } else {
                lotNumberField.classList.remove('error-border');
            }

            // Validate quantity (positive integer)
            if (quantity && (isNaN(quantity) || parseInt(quantity) <= 0)) {
                quantityField.classList.add('error-border');
                isValid = false;
            } else {
                quantityField.classList.remove('error-border');
            }

            // Validate expiration date (future date)
            if (expirationDate && new Date(expirationDate) <= new Date()) {
                expirationDateField.classList.add('error-border');
                isValid = false;
            } else {
                expirationDateField.classList.remove('error-border');
            }

            // Validate product name (not numeric, capitalize)
            if (productName && /^\d+$/.test(productName)) {
                productNameField.classList.add('error-border');
                isValid = false;
            } else {
                productNameField.classList.remove('error-border');
                // Auto-capitalize product name
                if (productName) {
                    productNameField.value = productName.charAt(0).toUpperCase() + productName.slice(1).toLowerCase();
                }
            }

            // Enable buttons based on form state
            const hasBarcode = barcodeField.value;
            const hasProductInfo = productId && productName;
            const allFieldsFilled = hasBarcode && hasProductInfo && lotNumber && quantity && expirationDate;
            
            // Enable link button if barcode exists but product info is missing
            linkBtn.disabled = !(hasBarcode && !hasProductInfo);
            
            // Enable save button only if all required fields are filled and valid
            saveBtn.disabled = !(allFieldsFilled && isValid);
        }

        function resetForm() {
            productForm.reset();
            barcodeField.value = '';
            productIdField.value = '';
            productNameField.value = '';
            
            // Reset field states
            [productIdField, productNameField, lotNumberField, quantityField, expirationDateField].forEach(field => {
                field.readOnly = true;
                field.classList.add('bg-gray-50');
                field.classList.remove('error-border');
            });
            
            saveBtn.disabled = true;
            linkBtn.disabled = true;
        }

        function showStatus(message, type) {
            statusDiv.textContent = message;
            statusDiv.className = `mt-6 text-center text-sm ${
                type === 'success' ? 'text-green-600' :
                type === 'error' ? 'text-red-600' :
                type === 'warning' ? 'text-yellow-600' :
                'text-gray-600'
            }`;
        }

        function showLoading(show) {
            if (show) {
                loadingDiv.classList.add('show');
            } else {
                loadingDiv.classList.remove('show');
            }
        }

        // Initialize form state
        resetForm();
        
        // Ensure loading screen is hidden on page load and load cameras
        document.addEventListener('DOMContentLoaded', function() {
            showLoading(false);
            loadCameras();
        });
    </script>
</body>
</html>
